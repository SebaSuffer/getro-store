---
import { getAllCategories } from '../utils/categories';
import { getProductsByCategory } from '../data/products';

let categories: any[] = [];
const categoryImages: Record<string, string> = {};

try {
  const allCategories = await getAllCategories();
  
  // Filtrar solo categorías que tienen productos
  const categoriesWithProducts = [];
  for (const cat of allCategories) {
    try {
      const products = await getProductsByCategory(cat.name);
      if (products.length > 0) {
        categoriesWithProducts.push(cat);
        categoryImages[cat.name] = cat.image_url;
      }
    } catch (error) {
      console.error(`[CATEGORIES-SECTION] Error checking products for ${cat.name}:`, error);
    }
  }
  
  categories = categoriesWithProducts;
  console.log(`[CATEGORIES-SECTION] ✅ Showing ${categories.length} categories with products:`, categories.map(c => c.name));
} catch (error: any) {
  console.error('[CATEGORIES-SECTION] Error:', error);
  // Fallback: solo mostrar Colgantes y Cadenas si hay error
  categoryImages['Cadenas'] = 'https://res.cloudinary.com/ddzoh72zv/image/upload/f_auto,q_auto/v1766458847/DSC05016_dwuz7c.jpg';
  categoryImages['Colgantes'] = 'https://res.cloudinary.com/ddzoh72zv/image/upload/f_auto,q_auto/v1766458846/DSC05010_zfxyxv.jpg';
  categories = [
    { name: 'Cadenas', image_url: categoryImages['Cadenas'], image_alt: 'Cadenas' },
    { name: 'Colgantes', image_url: categoryImages['Colgantes'], image_alt: 'Colgantes' }
  ];
}
---

<section id="categorias" class="bg-white py-32 scroll-mt-24">
  <div class="mx-auto max-w-[1920px] px-6 lg:px-12">
    <div class="mb-20 text-center">
      <span class="text-xs font-light uppercase tracking-[0.4em] text-black/60 mb-4 block">Explorar</span>
      <h2 class="text-4xl sm:text-5xl font-light text-black tracking-[0.05em] uppercase font-display">Categorías</h2>
    </div>
    
    <div class={`grid grid-cols-2 gap-4 sm:gap-6 max-w-4xl mx-auto ${categories.length > 2 ? 'sm:grid-cols-3 lg:grid-cols-6' : 'sm:grid-cols-2 lg:grid-cols-2'}`}>
      {categories.map((category) => (
        <a href={`/catalogo?categoria=${encodeURIComponent(category.name)}`} class="group relative aspect-square overflow-hidden bg-black max-w-xs mx-auto">
          <img
            src={category.image_url || categoryImages[category.name] || 'https://res.cloudinary.com/ddzoh72zv/image/upload/f_auto,q_auto/v1766458847/DSC05016_dwuz7c.jpg'}
            alt={category.image_alt || category.name}
            class="h-full w-full object-cover opacity-60 group-hover:opacity-80 transition-opacity duration-500"
            loading="lazy"
          />
          <div class="absolute inset-0 flex items-end p-4 sm:p-6">
            <span class="text-white font-light uppercase tracking-[0.2em] text-xs font-display">{category.name}</span>
          </div>
        </a>
      ))}
    </div>
  </div>
</section>
