---
import BaseLayout from '../layouts/BaseLayout.astro';
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
import { getTursoClient } from '../utils/turso';

// Obtener orderId de diferentes fuentes (Mercado Pago puede enviarlo como external_reference)
const orderId = Astro.url.searchParams.get('id') || 
                Astro.url.searchParams.get('external_reference') || 
                Astro.url.searchParams.get('preference_id') || '';
const paymentStatus = Astro.url.searchParams.get('status') || 'approved';
const paymentMethod = Astro.url.searchParams.get('method') || 'mercadopago';

// Obtener información de la orden desde la base de datos
let order = null;
if (orderId) {
  try {
    const client = getTursoClient();
    if (client) {
      const result = await client.execute({
        sql: 'SELECT * FROM orders WHERE id = ?',
        args: [orderId],
      });
      
      if (result.rows.length > 0) {
        const row = result.rows[0];
        order = {
          id: row.id,
          customer_name: row.customer_name,
          customer_email: row.customer_email,
          customer_phone: row.customer_phone,
          customer_address: row.customer_address,
          customer_rut: row.customer_rut,
          total_amount: row.total_amount,
          payment_method: row.payment_method,
          payment_status: row.payment_status || paymentStatus,
          shipping_status: row.shipping_status || 'not_shipped',
          items: JSON.parse(row.items),
          created_at: row.created_at,
        };
      }
    }
  } catch (error) {
    console.error('Error fetching order:', error);
  }
}
---

<BaseLayout title="Orden Confirmada - GOTRA">
  <div class="relative flex h-auto min-h-screen w-full flex-col">
    <Header />
    
    <main class="flex-grow bg-white">
      <section class="py-20">
        <div class="mx-auto max-w-2xl px-6 lg:px-12">
          <div class="text-center">
            <div class="mx-auto flex size-20 items-center justify-center mb-8">
              <span class="material-symbols-outlined text-black" style="font-size: 64px; font-weight: 300;">check_circle</span>
            </div>
            
            <span class="text-xs font-light uppercase tracking-[0.4em] text-black/60 mb-4 block">Confirmación</span>
            <h1 class="text-4xl sm:text-5xl font-light text-black tracking-[0.05em] uppercase mb-6 font-display">
              ¡Orden Confirmada!
            </h1>
            
            {order?.payment_status === 'approved' || paymentStatus === 'approved' ? (
              <p class="text-black/70 font-light text-sm tracking-wide mb-12 max-w-lg mx-auto leading-relaxed">
                ¡Gracias por tu compra{order?.customer_name ? `, ${order.customer_name}` : ''}! Tu pago fue exitoso. Te hemos enviado un comprobante a {order?.customer_email || 'tu correo electrónico'}.
              </p>
            ) : order?.payment_status === 'pending' || paymentStatus === 'pending' ? (
              <p class="text-black/70 font-light text-sm tracking-wide mb-12 max-w-lg mx-auto leading-relaxed">
                Tu pago está siendo procesado. Te notificaremos cuando se complete y te enviaremos un email de confirmación.
              </p>
            ) : (
              <p class="text-red-600 font-light text-sm tracking-wide mb-12 max-w-lg mx-auto leading-relaxed">
                Hubo un problema con tu pago. Por favor, contacta con nosotros si el pago fue realizado.
              </p>
            )}
            
            {orderId && (
              <div class="border border-black/10 bg-white p-8 mb-8">
                <p class="text-xs font-light uppercase tracking-[0.2em] text-black/60 mb-2">Número de Orden</p>
                <p class="text-xl font-light text-black tracking-wide mb-6">{orderId}</p>
                
                {order && (
                  <div class="border-t border-black/10 pt-6 space-y-4 text-left">
                    <div>
                      <p class="text-xs font-light uppercase tracking-[0.2em] text-black/60 mb-1">Resumen de Compra</p>
                      <div class="space-y-2 mt-3">
                        {order.items.map((item: any) => {
                          const itemPrice = item.product.price + (item.variation?.price_modifier || 0);
                          const totalItemPrice = itemPrice * item.quantity;
                          return (
                            <div class="flex justify-between items-start text-sm">
                              <div class="flex-1 pr-4">
                                <p class="text-black font-normal">{item.product.name}</p>
                                {item.variation && (
                                  <p class="text-black/60 text-xs mt-1">
                                    {[item.variation.brand, item.variation.thickness, item.variation.length].filter(Boolean).join(', ')}
                                  </p>
                                )}
                                <p class="text-black/50 text-xs mt-1">Cantidad: {item.quantity}</p>
                              </div>
                              <p class="text-black font-medium">${totalItemPrice.toLocaleString('es-CL')} CLP</p>
                            </div>
                          );
                        })}
                        <div class="border-t border-black/10 pt-3 mt-3">
                          <div class="flex justify-between items-center">
                            <span class="text-base font-semibold text-black">Total</span>
                            <span class="text-lg font-bold text-black">${order.total_amount.toLocaleString('es-CL')} CLP</span>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                )}
              </div>
            )}
            
            <div class="flex flex-col gap-4 sm:flex-row sm:justify-center">
              <a
                href="/catalogo"
                class="inline-flex h-12 items-center justify-center bg-black text-white px-10 text-xs font-light uppercase tracking-[0.2em] transition-all hover:bg-black/90"
              >
                Continuar Comprando
              </a>
              <a
                href="/"
                class="inline-flex h-12 items-center justify-center border border-black/20 text-black px-10 text-xs font-light uppercase tracking-[0.2em] transition-all hover:border-black/40"
              >
                Volver al Inicio
              </a>
            </div>
          </div>
        </div>
      </section>
    </main>
    
    <Footer />
  </div>
</BaseLayout>
